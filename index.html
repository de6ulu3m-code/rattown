<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä—ã—Å–æ-–ì—Ä–∞–¥: –¢—ë–º–Ω–æ–µ –ë—Ä–∞—Ç—Å—Ç–≤–æ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #ffcc00; --bg: #222; --blue: #4a69bd; 
            --sewer: #3d3d3d; --island: #e67e22; --stadium: #2ecc71; 
            --hospital: #e74c3c; --crimson: #800000; 
        }
        body { 
            background-color: var(--bg); color: white; 
            font-family: 'Noto Color Emoji', 'Courier New', monospace; 
            display: flex; flex-direction: column; align-items: center; 
            margin: 0; min-height: 100vh; overflow-x: hidden;
        }
        .city-header { 
            background: #111; width: 100%; text-align: center; 
            padding: 15px; border-bottom: 3px solid var(--gold); 
        }
        .container { 
            width: 90%; max-width: 400px; text-align: center; margin-top: 20px; 
            display: none; 
        }
        #main-view { display: block; }

        .stat-bar { font-size: 1.1rem; margin: 10px 0; color: var(--gold); }
        .btn { 
            background: #555; color: white; border: none; padding: 12px 10px; 
            border-radius: 5px; cursor: pointer; margin: 5px; 
            font-family: 'Noto Color Emoji', monospace; transition: 0.2s; 
            font-size: 0.9rem;
        }
        .btn:hover { background: var(--gold); color: black; }
        .btn:disabled { background: #333 !important; color: #666 !important; cursor: not-allowed; opacity: 0.5; }
        
        #mafia-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center; 
        }
        .mafia-card { 
            background: #1a1a1a; border: 4px solid #ff4444; 
            padding: 30px; border-radius: 20px; max-width: 320px; 
        }
        
        .hidden { display: none !important; }
        .status-badge { font-size: 0.8rem; padding: 4px 12px; border-radius: 10px; margin-top: 5px; display: inline-block; }
        
        /* –°–¢–ò–õ–ò –†–´–ù–ö–ê */
        #market-game-zone {
            background: #333; border: 2px dashed var(--gold);
            height: 300px; position: relative; overflow: hidden; margin-top: 10px;
            cursor: crosshair;
        }
        .falling-cheese { 
            position: absolute; font-size: 30px; cursor: pointer; 
            user-select: none; transition: transform 0.1s;
        }
        .falling-cheese:active { transform: scale(1.5); }
    </style>
</head>
<body>

<div id="mafia-overlay">
    <div class="mafia-card">
        <div id="mafia-icon" style="font-size: 60px;">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
        <h2 id="mafia-title" style="color: #ff4444;">–ó–ê–°–ê–î–ê!</h2>
        <p id="mafia-msg-text"></p>
        <div id="mafia-btns"></div>
        <p id="fight-status" style="margin-top: 15px; font-weight: bold; color: var(--gold);"></p>
    </div>
</div>

<div class="city-header">
    <h1>üèôÔ∏è –ö–†–´–°–û-–ì–†–ê–î</h1>
    <div class="stat-bar">üßÄ –°—ã—Ä: <span id="balance">0</span> | ‚≠ê –†–µ–ø–∞: <span id="rep-display">0</span></div>
    <div id="role-badge" class="status-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="container" id="main-view">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn" onclick="startMarketGame()">üçé –ù–∞ —Ä—ã–Ω–æ–∫</button>
        <button class="btn" onclick="openView('cityhall-view')" style="background: var(--blue);">üèõÔ∏è –ú—ç—Ä–∏—è</button>
        <button class="btn" id="btn-stadium" onclick="openView('stadium-view')" style="background: var(--stadium);">üèüÔ∏è –°—Ç–∞–¥–∏–æ–Ω</button>
        <button class="btn" id="btn-hospital" onclick="openView('hospital-view')" style="background: var(--hospital);">üè• –ë–æ–ª—å–Ω–∏—Ü–∞</button>
        <button class="btn" id="btn-airport" onclick="openAirport()" style="background: #a29bfe; color: black;">‚úàÔ∏è –ê—ç—Ä–æ–ø–æ—Ä—Ç</button>
        <button class="btn" onclick="openView('sewer-view')" style="background: var(--sewer);">üï≥Ô∏è –¢—Ä—É–±—ã</button>
        
        <button class="btn hidden" id="btn-rob" onclick="robberyAttempt()" style="background: var(--crimson); grid-column: span 2; font-weight: bold;">üî´ –û–ì–†–ê–ë–ò–¢–¨ –ü–†–û–•–û–ñ–ï–ì–û</button>
        <button class="btn hidden" id="btn-leave-mafia" onclick="quitMafiaRequest()" style="background: #444; grid-column: span 2; font-size: 0.75rem;">üö™ –í—ã–π—Ç–∏ –∏–∑ —Ç—ë–º–Ω–æ–≥–æ –æ–±—â–µ—Å—Ç–≤–∞</button>
    </div>
    
    <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
        <button class="btn" onclick="travelToBar()">üçª –ë–∞—Ä</button>
        <button class="btn" onclick="travelToMetro()">üöá –ú–µ—Ç—Ä–æ</button>
        <button class="btn" onclick="saveGame(); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');" style="background: #00d2d3; color: black;">üè¶ –°–µ–π—Ñ</button>
    </div>
    <button class="btn" onclick="resetGame()" style="background: #ff4444; margin-top: 20px; font-size: 0.6rem; opacity: 0.5;">–°–ë–†–û–° –ò–ì–†–´</button>
</div>

<div class="container" id="market-view">
    <h3>üçé –†—ã–Ω–æ–∫: –õ–æ–≤–∏ —Å—ã—Ä!</h3>
    <p>–ö–ª–∏–∫–∞–π –Ω–∞ —Å—ã—Ä, –ø–æ–∫–∞ –æ–Ω –ø–∞–¥–∞–µ—Ç!</p>
    <div id="market-game-zone"></div>
    <p style="margin-top:10px;">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: <span id="market-timer">15</span>—Å</p>
    <button class="btn" onclick="stopMarketGame()" style="width:100%">–ó–∞–∫–æ–Ω—á–∏—Ç—å —Ä–∞–Ω—å—à–µ</button>
</div>

<div class="container" id="stadium-view"><h2>üèüÔ∏è –ê—Ä–µ–Ω–∞</h2><button class="btn" onclick="trainTail()">–¢—Ä–µ–Ω–∏—Ç—å (10üßÄ)</button><button class="btn" onclick="exitView('stadium-view')">–ù–∞–∑–∞–¥</button></div>
<div class="container" id="hospital-view"><h2>üè• –ë–æ–ª—å–Ω–∏—Ü–∞</h2><button class="btn" onclick="buyVitamins()">–í–∏—Ç–∞–º–∏–Ω—ã (25üßÄ)</button><button class="btn" onclick="exitView('hospital-view')">–ù–∞–∑–∞–¥</button></div>
<div class="container" id="sewer-view"><h2>üï≥Ô∏è –¢—Ä—É–±—ã</h2><button class="btn" onclick="rescueMouse()">–°–ø–∞—Å—Ç–∏ –º—ã—à—å (100üßÄ)</button><button class="btn" onclick="exitView('sewer-view')">–ù–∞–∑–∞–¥</button></div>
<div class="container" id="cityhall-view"><h2>üèõÔ∏è –ú—ç—Ä–∏—è</h2><button class="btn" onclick="exitView('cityhall-view')">–ù–∞–∑–∞–¥</button></div>

<script>
    let cheese = 0;
    let reputation = 0;
    let isMafia = false;
    let gameActive = false;
    let marketInterval;

    function saveGame() {
        localStorage.setItem('rat_cheese', cheese);
        localStorage.setItem('rat_rep', reputation);
        localStorage.setItem('rat_mafia', isMafia);
    }

    function loadGame() {
        cheese = parseInt(localStorage.getItem('rat_cheese')) || 0;
        reputation = parseInt(localStorage.getItem('rat_rep')) || 0;
        isMafia = localStorage.getItem('rat_mafia') === 'true';
        updateUI();
    }

    function updateUI() {
        document.getElementById('balance').innerText = cheese;
        document.getElementById('rep-display').innerText = reputation;
        const badge = document.getElementById('role-badge');
        
        if(isMafia) {
            badge.innerText = "üï∂Ô∏è –í –ì–†–£–ü–ü–ò–†–û–í–ö–ï"; badge.style.background = "#800000";
            document.getElementById('btn-rob').classList.remove('hidden');
            document.getElementById('btn-leave-mafia').classList.remove('hidden');
            document.getElementById('btn-stadium').disabled = true;
            document.getElementById('btn-hospital').disabled = true;
        } else {
            badge.innerText = "üêπ –ì–†–ê–ñ–î–ê–ù–ò–ù"; badge.style.background = "#444";
            document.getElementById('btn-rob').classList.add('hidden');
            document.getElementById('btn-leave-mafia').classList.add('hidden');
            document.getElementById('btn-stadium').disabled = false;
            document.getElementById('btn-hospital').disabled = false;
        }
    }

    // --- –õ–û–ì–ò–ö–ê –†–´–ù–ö–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---
    function startMarketGame() {
        if(checkMafiaTrigger()) return;
        openView('market-view');
        gameActive = true;
        let timeLeft = 15;
        document.getElementById('market-timer').innerText = timeLeft;
        const zone = document.getElementById('market-game-zone');
        zone.innerHTML = "";

        // –¢–∞–π–º–µ—Ä –∏–≥—Ä—ã
        marketInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('market-timer').innerText = timeLeft;
            if(timeLeft <= 0) stopMarketGame();
        }, 1000);

        spawnCheese();
    }

    function spawnCheese() {
        if(!gameActive) return;
        const zone = document.getElementById('market-game-zone');
        const item = document.createElement('div');
        item.className = 'falling-cheese';
        item.innerText = "üßÄ";
        item.style.left = Math.random() * 85 + "%";
        item.style.top = "-40px";
        zone.appendChild(item);

        let pos = -40;
        let fall = setInterval(() => {
            if(!gameActive) { clearInterval(fall); return; }
            pos += 4; // –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è
            item.style.top = pos + "px";

            if(pos > 300) {
                clearInterval(fall);
                if(item.parentNode) zone.removeChild(item);
            }
        }, 30);

        item.onclick = (e) => {
            e.stopPropagation();
            cheese += 2;
            updateUI();
            clearInterval(fall);
            if(item.parentNode) zone.removeChild(item);
        };

        // –ß–∞—Å—Ç–æ—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å—ã—Ä–∞
        setTimeout(spawnCheese, 600);
    }

    function stopMarketGame() {
        gameActive = false;
        clearInterval(marketInterval);
        saveGame();
        exitView('market-view');
    }

    // --- –û–°–¢–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
    function checkMafiaTrigger() {
        if (isMafia) return false;
        if (Math.random() < 0.15 && cheese > 50) {
            showMafiaWindow();
            return true;
        }
        return false;
    }

    function showMafiaWindow() {
        document.getElementById('mafia-overlay').style.display = 'flex';
        const btns = document.getElementById('mafia-btns');
        if (reputation < 10) {
            document.getElementById('mafia-title').innerText = "–í–ï–†–ë–û–í–ö–ê";
            document.getElementById('mafia-msg-text').innerText = "–ú–∞—Ñ–∏—è –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ç–µ–±–µ –¥–æ–ª—é. –í—Å—Ç—É–ø–∏—à—å?";
            btns.innerHTML = `<button class="btn" onclick="joinMafia()">–í–°–¢–£–ü–ò–¢–¨</button><button class="btn" onclick="startFight(false)">–û–¢–ö–ê–ó–ê–¢–¨</button>`;
        } else {
            document.getElementById('mafia-title').innerText = "–ó–ê–°–ê–î–ê!";
            document.getElementById('mafia-msg-text').innerText = "–û—Ç–¥–∞–≤–∞–π 30% —Å—ã—Ä–∞!";
            btns.innerHTML = `<button class="btn" onclick="payMafia()">–û–¢–î–ê–¢–¨</button><button class="btn" onclick="startFight(false)">–ë–ò–¢–¨–°–Ø!</button>`;
        }
    }

    function travelToBar() { if(!checkMafiaTrigger()) window.location.href = "/ratbar/"; }
    function travelToMetro() { if(!checkMafiaTrigger()) window.location.href = "/ratmetro/"; }
    
    function joinMafia() { isMafia = true; hideMafia(); }
    function payMafia() { cheese -= Math.floor(cheese * 0.3); hideMafia(); }
    function hideMafia() { document.getElementById('mafia-overlay').style.display = 'none'; updateUI(); saveGame(); }

    function startFight(isQuitting) {
        document.getElementById('fight-status').innerText = "–ë–û–ô...";
        setTimeout(() => {
            if(Math.random() > 0.5) {
                if(isQuitting) { isMafia = false; reputation = 0; alert("–°–≤–æ–±–æ–¥–µ–Ω!"); }
                else { cheese += 100; alert("–ü–æ–±–µ–¥–∏–ª!"); }
            } else { cheese = 0; alert("–ü—Ä–æ–∏–≥—Ä–∞–ª!"); }
            hideMafia();
        }, 1000);
    }

    function quitMafiaRequest() {
        document.getElementById('mafia-overlay').style.display = 'flex';
        document.getElementById('mafia-title').innerText = "–í–´–•–û–î";
        document.getElementById('mafia-msg-text').innerText = "–ú–∞—Ñ–∏—è —Ç—Ä–µ–±—É–µ—Ç —Å—ã—Ä –∑–∞ –≤—ã—Ö–æ–¥!";
        document.getElementById('mafia-btns').innerHTML = `<button class="btn" onclick="startFight(true)">–î–†–ê–¢–¨–°–Ø</button><button class="btn" onclick="hideMafia()">–û–°–¢–ê–¢–¨–°–Ø</button>`;
    }

    function robberyAttempt() {
        if (Math.random() < 0.6) { cheese += 50; reputation -= 5; alert("+50üßÄ"); }
        else { reputation -= 15; alert("–ü–æ–±–∏–ª–∏! -15‚≠ê"); }
        updateUI(); saveGame();
    }

    function openView(id) { document.querySelectorAll('.container').forEach(v => v.style.display = 'none'); document.getElementById(id).style.display = 'block'; }
    function exitView(id) { document.getElementById(id).style.display = 'none'; document.getElementById('main-view').style.display = 'block'; }
    function trainTail() { if(cheese>=10){ cheese-=10; reputation+=2; updateUI(); } }
    function buyVitamins() { if(cheese>=25){ cheese-=25; reputation+=5; updateUI(); } }
    function rescueMouse() { if(cheese>=100){ cheese-=100; reputation+=20; updateUI(); } }
    function openAirport() { if(confirm("–õ–µ—Ç–∏–º –∑–∞ 50?")){ cheese-=50; alert("–£–ª–µ—Ç–µ–ª!"); updateUI(); } }
    function resetGame() { localStorage.clear(); location.reload(); }

    window.onload = loadGame;
</script>
</body>
</html>
