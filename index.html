<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä—ã—Å–æ-–ì—Ä–∞–¥: –¢—ë–º–Ω–æ–µ –ë—Ä–∞—Ç—Å—Ç–≤–æ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #ffcc00; --bg: #222; --blue: #4a69bd; --sewer: #3d3d3d; --island: #e67e22; --stadium: #2ecc71; --hospital: #e74c3c; --crimson: #800000; }
        body { background-color: var(--bg); color: white; font-family: 'Noto Color Emoji', 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; min-height: 100vh; }
        .city-header { background: #111; width: 100%; text-align: center; padding: 15px; border-bottom: 3px solid var(--gold); }
        .container { width: 90%; max-width: 400px; text-align: center; margin-top: 20px; }
        .stat-bar { font-size: 1.1rem; margin: 10px 0; color: var(--gold); }
        .btn { background: #555; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; font-family: 'Noto Color Emoji', monospace; transition: 0.2s; }
        .btn:hover { background: var(--gold); color: black; }
        .btn:disabled { background: #333 !important; color: #666 !important; cursor: not-allowed; }
        
        #mafia-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .mafia-card { background: #1a1a1a; border: 4px solid #ff4444; padding: 30px; border-radius: 20px; max-width: 320px; }
        .hidden { display: none !important; }
        .status-badge { font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; margin-top: 5px; display: inline-block; }
    </style>
</head>
<body>

<div id="mafia-overlay">
    <div class="mafia-card">
        <div id="mafia-icon" style="font-size: 60px;">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
        <h2 id="mafia-title" style="color: #ff4444;">–ó–ê–°–ê–î–ê!</h2>
        <p id="mafia-msg-text">–¢–µ–∫—Å—Ç...</p>
        <div id="mafia-btns"></div>
        <p id="fight-status" style="margin-top: 15px; font-weight: bold; color: var(--gold);"></p>
    </div>
</div>

<div class="city-header">
    <h1>üèôÔ∏è –ö–†–´–°–û-–ì–†–ê–î</h1>
    <div class="stat-bar">–°—ã—Ä: <span id="balance">0</span> | –†–µ–ø–∞: <span id="rep-display">0</span></div>
    <div id="role-badge" class="status-badge" style="background: #444;">–û–±—ã—á–Ω—ã–π –∫—Ä—ã—Å</div>
</div>

<div class="container" id="main-view">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn" onclick="startMarketGame()">üçé –†—ã–Ω–æ–∫</button>
        <button class="btn" onclick="openCityHall()" style="background: var(--blue);">üèõÔ∏è –ú—ç—Ä–∏—è</button>
        <button class="btn" id="btn-stadium" onclick="openView('stadium-view')">üèüÔ∏è –°—Ç–∞–¥–∏–æ–Ω</button>
        <button class="btn" id="btn-hospital" onclick="openView('hospital-view')">üè• –ë–æ–ª—å–Ω–∏—Ü–∞</button>
        <button class="btn" id="btn-airport" onclick="openAirport()">‚úàÔ∏è –ê—ç—Ä–æ–ø–æ—Ä—Ç</button>
        <button class="btn" onclick="openView('sewer-view')">üï≥Ô∏è –¢—Ä—É–±—ã</button>
        
        <button class="btn hidden" id="btn-rob" onclick="robberyAttempt()" style="background: var(--crimson); grid-column: span 2;">üî´ –û–ì–†–ê–ë–ò–¢–¨ –ö–†–´–°–£</button>
        
        <button class="btn hidden" id="btn-leave-mafia" onclick="quitMafiaRequest()" style="background: #444; grid-column: span 2; font-size: 0.7rem;">üö™ –í—ã–π—Ç–∏ –∏–∑ —Ç—ë–º–Ω–æ–≥–æ –æ–±—â–µ—Å—Ç–≤–∞</button>
    </div>
    <div style="margin-top: 15px;">
        <button class="btn" onclick="travelTo('/ratbar/')">üçª –ë–∞—Ä</button>
        <button class="btn" onclick="travelTo('/ratmetro/')">üöá –ú–µ—Ç—Ä–æ</button>
    </div>
</div>

<div class="container" id="stadium-view" style="display:none;"><h2>üèüÔ∏è –°—Ç–∞–¥–∏–æ–Ω</h2><button class="btn" onclick="trainTail()">–¢—Ä–µ–Ω–∏—Ç—å (10üßÄ)</button><button class="btn" onclick="exitView('stadium-view')">–ù–∞–∑–∞–¥</button></div>
<div class="container" id="hospital-view" style="display:none;"><h2>üè• –ë–æ–ª—å–Ω–∏—Ü–∞</h2><button class="btn" onclick="buyVitamins()">–í–∏—Ç–∞–º–∏–Ω—ã (25üßÄ)</button><button class="btn" onclick="exitView('hospital-view')">–ù–∞–∑–∞–¥</button></div>
<div class="container" id="sewer-view" style="display:none;"><h2>üï≥Ô∏è –ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è</h2><button class="btn" onclick="rescueMouse()">–°–ø–∞—Å—Ç–∏ –º—ã—à—å (100üßÄ)</button><button class="btn" onclick="exitView('sewer-view')">–ù–∞–∑–∞–¥</button></div>
<div class="container" id="cityhall-view" style="display:none;"><h2>üèõÔ∏è –ú—ç—Ä–∏—è</h2><button class="btn" onclick="exitView('cityhall-view')">–ù–∞–∑–∞–¥</button></div>

<script>
    let cheese = 0;
    let reputation = 0;
    let isMafia = false;

    function saveGame() {
        localStorage.setItem('ratCheese', cheese);
        localStorage.setItem('ratRep', reputation);
        localStorage.setItem('ratIsMafia', isMafia);
    }

    function loadGame() {
        cheese = parseInt(localStorage.getItem('ratCheese')) || 0;
        reputation = parseInt(localStorage.getItem('ratRep')) || 0;
        isMafia = localStorage.getItem('ratIsMafia') === 'true';
        updateUI();
    }

    function updateUI() {
        document.getElementById('balance').innerText = cheese;
        document.getElementById('rep-display').innerText = reputation;
        
        const badge = document.getElementById('role-badge');
        if(isMafia) {
            badge.innerText = "üï∂Ô∏è –í –ì–†–£–ü–ü–ò–†–û–í–ö–ï"; badge.style.background = "#800000";
            document.getElementById('btn-rob').classList.remove('hidden');
            document.getElementById('btn-leave-mafia').classList.remove('hidden');
            document.getElementById('btn-stadium').disabled = true;
            document.getElementById('btn-hospital').disabled = true;
            document.getElementById('btn-airport').disabled = true;
        } else {
            badge.innerText = "üêπ –ì–†–ê–ñ–î–ê–ù–ò–ù"; badge.style.background = "#444";
            document.getElementById('btn-rob').classList.add('hidden');
            document.getElementById('btn-leave-mafia').classList.add('hidden');
            document.getElementById('btn-stadium').disabled = false;
            document.getElementById('btn-hospital').disabled = false;
            document.getElementById('btn-airport').disabled = false;
        }
    }

    // --- –õ–û–ì–ò–ö–ê –ú–ê–§–ò–ò ---
    function checkMafia() {
        if (Math.random() < 0.15 && cheese > 50) {
            document.getElementById('mafia-overlay').style.display = 'flex';
            document.getElementById('mafia-btns').innerHTML = "";
            document.getElementById('fight-status').innerText = "";

            if (!isMafia && reputation < 10) {
                document.getElementById('mafia-title').innerText = "–ü–†–ò–ì–õ–ê–®–ï–ù–ò–ï";
                document.getElementById('mafia-msg-text').innerText = "–ú–∞—Ñ–∏—è –≤–∏–¥–∏—Ç –≤ —Ç–µ–±–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª. –í—Å—Ç—É–ø–∏—à—å –≤ –Ω–∞—à–∏ —Ä—è–¥—ã?";
                document.getElementById('mafia-btns').innerHTML = `
                    <button class="btn" onclick="startFight()">–û—Ç–∫–∞–∑–∞—Ç—å (–ë–∏—Ç–≤–∞)</button>
                    <button class="btn" style="background:var(--crimson)" onclick="joinMafia()">–í—Å—Ç—É–ø–∏—Ç—å üï∂Ô∏è</button>
                `;
            } else {
                document.getElementById('mafia-title').innerText = "–ó–ê–°–ê–î–ê!";
                document.getElementById('mafia-msg-text').innerText = "–û–Ω–∏ —Ö–æ—Ç—è—Ç —Ç–≤–æ–π —Å—ã—Ä!";
                document.getElementById('mafia-btns').innerHTML = `
                    <button class="btn" onclick="payMafia()">–û—Ç–¥–∞—Ç—å 30%</button>
                    <button class="btn" style="background:#c0392b" onclick="startFight()">–ë–ò–¢–¨–°–Ø!</button>
                `;
            }
            return true;
        }
        return false;
    }

    function joinMafia() {
        isMafia = true;
        alert("–¢–µ–ø–µ—Ä—å —Ç—ã ‚Äî —á–∞—Å—Ç—å —Å–µ–º—å–∏. –¢–µ–±–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≥—Ä–∞–±–µ–∂–∏, –Ω–æ –ø—É—Ç—å –≤ —Å–≤–µ—Ç–ª–æ–µ –æ–±—â–µ—Å—Ç–≤–æ –∑–∞–∫—Ä—ã—Ç!");
        hideMafia();
    }

    function quitMafiaRequest() {
        document.getElementById('mafia-overlay').style.display = 'flex';
        document.getElementById('mafia-title').innerText = "–ü–†–ï–î–ê–¢–ï–õ–¨–°–¢–í–û?";
        document.getElementById('mafia-msg-text').innerText = "–ú–∞—Ñ–∏—è –≥–æ–≤–æ—Ä–∏—Ç: '–ö—É–¥–∞ —ç—Ç–æ —Ç—ã? –ë–µ–∑ —Å—ã—Ä–∞ –º—ã —Ç–µ–±—è –Ω–µ –æ—Ç–ø—É—Å—Ç–∏–º!'";
        document.getElementById('mafia-btns').innerHTML = `
            <button class="btn" onclick="hideMafia()">–û—Å—Ç–∞—Ç—å—Å—è</button>
            <button class="btn" style="background:#c0392b" onclick="startFight(true)">–ü–û–ü–´–¢–ê–¢–¨–°–Ø –£–ô–¢–ò</button>
        `;
    }

    function startFight(quitting = false) {
        let status = document.getElementById('fight-status');
        status.innerText = "–ë–û–ô... üî•";
        let winChance = 0.5 + (reputation/200) - (cheese/50000);
        
        setTimeout(() => {
            if (Math.random() < winChance) {
                alert("–ü–æ–±–µ–¥–∞! –í—ã –æ—Ç–±–∏–ª–∏—Å—å.");
                if(quitting) { isMafia = false; reputation = 0; alert("–í—ã —Å–≤–æ–±–æ–¥–Ω—ã, –Ω–æ –≤–∞—à–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏—è –æ–±–Ω—É–ª–µ–Ω–∞."); }
                else { cheese += 200; reputation += 10; }
                hideMafia();
            } else {
                cheese = 0;
                alert("–í–∞—Å –ø–æ–±–∏–ª–∏ –∏ –æ–±–æ–±—Ä–∞–ª–∏ –¥–æ –Ω–∏—Ç–∫–∏!");
                hideMafia();
            }
        }, 1200);
    }

    // --- –û–ì–†–ê–ë–õ–ï–ù–ò–ï ---
    function robberyAttempt() {
        let loot = Math.floor(Math.random() * 60) + 10;
        if (Math.random() > 0.4) {
            cheese += loot; reputation -= 5;
            alert("–£–¥–∞—á–Ω—ã–π –≥–æ–ø-—Å—Ç–æ–ø! + " + loot + " üßÄ");
        } else {
            reputation -= 15;
            alert("–ñ–µ—Ä—Ç–≤–∞ –¥–∞–ª–∞ —Å–¥–∞—á–∏! –í—ã —Å –ø–æ–∑–æ—Ä–æ–º —É–±–µ–∂–∞–ª–∏ (-15 –†–µ–ø)");
        }
        updateUI(); saveGame();
    }

    function payMafia() { cheese -= Math.floor(cheese * 0.3); hideMafia(); }
    function hideMafia() { document.getElementById('mafia-overlay').style.display = 'none'; updateUI(); saveGame(); }
    function openView(id) { if(!checkMafia()){ document.getElementById('main-view').style.display='none'; document.getElementById(id).style.display='block'; } }
    function exitView(id) { document.getElementById(id).style.display='none'; document.getElementById('main-view').style.display='block'; }
    function travelTo(url) { if(!checkMafia()) window.location.href = url; }
    
    // –ë–∞–∑–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    function trainTail() { if(cheese>=10){ cheese-=10; reputation+=2; updateUI(); saveGame(); } }
    function buyVitamins() { if(cheese>=25){ cheese-=25; reputation+=5; updateUI(); saveGame(); } }
    function rescueMouse() { if(cheese>=100){ cheese-=100; reputation+=20; updateUI(); saveGame(); } }
    function startMarketGame() { if(!checkMafia()){ alert("–í—ã –Ω–∞ —Ä—ã–Ω–∫–µ!"); cheese+=10; updateUI(); saveGame(); } }
    function openAirport() { if(confirm("–õ–µ—Ç–∏–º –Ω–∞ –æ—Å—Ç—Ä–æ–≤ –∑–∞ 50?")){ cheese-=50; alert("–í—ã –Ω–∞ –æ—Å—Ç—Ä–æ–≤–µ!"); } }
    function openCityHall() { openView('cityhall-view'); }
    
    window.onload = loadGame;
</script>
</body>
</html>
