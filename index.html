<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä—ã—Å–æ-–ì—Ä–∞–¥: –¢—ë–º–Ω–æ–µ –ë—Ä–∞—Ç—Å—Ç–≤–æ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #ffcc00; --bg: #222; --blue: #4a69bd; 
            --sewer: #3d3d3d; --island: #e67e22; --stadium: #2ecc71; 
            --hospital: #e74c3c; --crimson: #800000; 
        }
        body { 
            background-color: var(--bg); color: white; 
            font-family: 'Noto Color Emoji', 'Courier New', monospace; 
            display: flex; flex-direction: column; align-items: center; 
            margin: 0; min-height: 100vh; overflow-x: hidden;
        }
        .city-header { 
            background: #111; width: 100%; text-align: center; 
            padding: 15px; border-bottom: 3px solid var(--gold); 
        }
        .container { 
            width: 90%; max-width: 400px; text-align: center; margin-top: 20px; 
            display: none; 
        }
        #main-view { display: block; }

        .stat-bar { font-size: 1.1rem; margin: 10px 0; color: var(--gold); }
        .btn { 
            background: #555; color: white; border: none; padding: 12px 10px; 
            border-radius: 5px; cursor: pointer; margin: 5px; 
            font-family: 'Noto Color Emoji', monospace; transition: 0.2s; 
            font-size: 0.9rem;
        }
        .btn:hover { background: var(--gold); color: black; }
        .btn:disabled { background: #333 !important; color: #666 !important; cursor: not-allowed; opacity: 0.5; }
        
        #mafia-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center; 
        }
        .mafia-card { 
            background: #1a1a1a; border: 4px solid #ff4444; 
            padding: 30px; border-radius: 20px; max-width: 320px; 
        }
        
        .hidden { display: none !important; }
        .status-badge { font-size: 0.8rem; padding: 4px 12px; border-radius: 10px; margin-top: 5px; display: inline-block; }
        
        #market-game-zone {
            background: #333; border: 2px dashed var(--gold);
            height: 300px; position: relative; overflow: hidden; margin-top: 10px;
        }
        .falling-cheese { position: absolute; font-size: 30px; cursor: pointer; user-select: none; }
    </style>
</head>
<body>

<div id="mafia-overlay">
    <div class="mafia-card">
        <div id="mafia-icon" style="font-size: 60px;">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
        <h2 id="mafia-title">–ó–ê–°–ê–î–ê!</h2>
        <p id="mafia-msg-text"></p>
        <div id="mafia-btns"></div>
        <p id="fight-status" style="margin-top: 15px; font-weight: bold; color: var(--gold);"></p>
    </div>
</div>

<div class="city-header">
    <h1>üèôÔ∏è –ö–†–´–°–û-–ì–†–ê–î</h1>
    <div class="stat-bar">üßÄ –°—ã—Ä: <span id="balance">0</span> | ‚≠ê –†–µ–ø–∞: <span id="rep-display">0</span></div>
    <div id="role-badge" class="status-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="container" id="main-view">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn" onclick="startMarketGame()">üçé –ù–∞ —Ä—ã–Ω–æ–∫</button>
        <button class="btn" onclick="openView('cityhall-view')" style="background: var(--blue);">üèõÔ∏è –ú—ç—Ä–∏—è</button>
        <button class="btn" id="btn-stadium" onclick="openView('stadium-view')" style="background: var(--stadium);">üèüÔ∏è –°—Ç–∞–¥–∏–æ–Ω</button>
        <button class="btn" id="btn-hospital" onclick="openView('hospital-view')" style="background: var(--hospital);">üè• –ë–æ–ª—å–Ω–∏—Ü–∞</button>
        <button class="btn" id="btn-airport" onclick="openView('airport-view')" style="background: #a29bfe; color: black;">‚úàÔ∏è –ê—ç—Ä–æ–ø–æ—Ä—Ç</button>
        <button class="btn" onclick="openView('sewer-view')" style="background: var(--sewer);">üï≥Ô∏è –¢—Ä—É–±—ã</button>
        
        <button class="btn hidden" id="btn-rob" onclick="robberyAttempt()" style="background: var(--crimson); grid-column: span 2;">üî´ –û–ì–†–ê–ë–ò–¢–¨ –ü–†–û–•–û–ñ–ï–ì–û</button>
        <button class="btn hidden" id="btn-leave-mafia" onclick="quitMafiaRequest()" style="background: #444; grid-column: span 2;">üö™ –í—ã–π—Ç–∏ –∏–∑ –º–∞—Ñ–∏–∏</button>
    </div>
    
    <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
        <button class="btn" onclick="travelToBar()">üçª –ë–∞—Ä</button>
        <button class="btn" onclick="travelToMetro()">üöá –ú–µ—Ç—Ä–æ</button>
        <button class="btn" onclick="saveGame(); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');" style="background: #00d2d3; color: black;">üè¶ –°–µ–π—Ñ</button>
    </div>
    <button class="btn" onclick="resetGame()" style="background: #ff4444; margin-top: 10px; font-size: 0.6rem; opacity: 0.5;">–°–ë–†–û–°</button>
</div>

<div class="container" id="market-view">
    <h3>üçé –†—ã–Ω–æ–∫</h3>
    <div id="market-game-zone"></div>
    <p>–û—Å—Ç–∞–ª–æ—Å—å: <span id="market-timer">15</span>—Å</p>
</div>

<div class="container" id="airport-view">
    <h2>‚úàÔ∏è –ê—ç—Ä–æ–ø–æ—Ä—Ç "–ö—Ä—ã–ª–æ"</h2>
    <p>–ë–∏–ª–µ—Ç –Ω–∞ –°—ã—Ä–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞ —Å—Ç–æ–∏—Ç 100 üßÄ.</p>
    <button class="btn" onclick="buyFlight()" style="width:100%; background: #a29bfe; color: black;">–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç (100 üßÄ)</button>
    <button class="btn" onclick="exitView('airport-view')" style="width:100%; margin-top:10px;">–ù–∞–∑–∞–¥</button>
</div>

<div class="container" id="stadium-view"><h2>üèüÔ∏è –ê—Ä–µ–Ω–∞</h2><button class="btn" onclick="trainTail()">–¢—Ä–µ–Ω–∏—Ç—å (10üßÄ)</button><button class="btn" onclick="exitView('stadium-view')">–ù–∞–∑–∞–¥</button></div>
<div class="container" id="hospital-view"><h2>üè• –ë–æ–ª—å–Ω–∏—Ü–∞</h2><button class="btn" onclick="buyVitamins()">–í–∏—Ç–∞–º–∏–Ω—ã (25üßÄ)</button><button class="btn" onclick="exitView('hospital-view')">–ù–∞–∑–∞–¥</button></div>
<div class="container" id="sewer-view"><h2>üï≥Ô∏è –¢—Ä—É–±—ã</h2><button class="btn" onclick="rescueMouse()">–°–ø–∞—Å—Ç–∏ –º—ã—à—å (100üßÄ)</button><button class="btn" onclick="exitView('sewer-view')">–ù–∞–∑–∞–¥</button></div>
<div class="container" id="cityhall-view"><h2>üèõÔ∏è –ú—ç—Ä–∏—è</h2><button class="btn" onclick="exitView('cityhall-view')">–ù–∞–∑–∞–¥</button></div>

<script>
    let cheese = 0;
    let reputation = 0;
    let isMafia = false;
    let gameActive = false;

    function saveGame() {
        localStorage.setItem('rat_cheese', cheese);
        localStorage.setItem('rat_rep', reputation);
        localStorage.setItem('rat_mafia', isMafia);
    }

    function loadGame() {
        cheese = parseInt(localStorage.getItem('rat_cheese')) || 0;
        reputation = parseInt(localStorage.getItem('rat_rep')) || 0;
        isMafia = localStorage.getItem('rat_mafia') === 'true';
        updateUI();
    }

    function updateUI() {
        if (cheese < 0) cheese = 0; // –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –º–∏–Ω—É—Å–∞
        document.getElementById('balance').innerText = cheese;
        document.getElementById('rep-display').innerText = reputation;
        const badge = document.getElementById('role-badge');
        
        if(isMafia) {
            badge.innerText = "üï∂Ô∏è –ú–ê–§–ò–Ø"; badge.style.background = "#800000";
            document.getElementById('btn-rob').classList.remove('hidden');
            document.getElementById('btn-leave-mafia').classList.remove('hidden');
            document.getElementById('btn-stadium').disabled = true;
            document.getElementById('btn-hospital').disabled = true;
            document.getElementById('btn-airport').disabled = true;
        } else {
            badge.innerText = "üêπ –ì–†–ê–ñ–î–ê–ù–ò–ù"; badge.style.background = "#444";
            document.getElementById('btn-rob').classList.add('hidden');
            document.getElementById('btn-leave-mafia').classList.add('hidden');
            document.getElementById('btn-stadium').disabled = false;
            document.getElementById('btn-hospital').disabled = false;
            document.getElementById('btn-airport').disabled = false;
        }
    }

    // --- –õ–û–ì–ò–ö–ê –ü–û–ö–£–ü–û–ö (–ë–ï–ó –ú–ò–ù–£–°–û–í) ---
    function trainTail() {
        if(cheese >= 10) { cheese -= 10; reputation += 2; updateUI(); saveGame(); } 
        else { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—ã—Ä–∞!"); }
    }

    function buyVitamins() {
        if(cheese >= 25) { cheese -= 25; reputation += 5; updateUI(); saveGame(); } 
        else { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—ã—Ä–∞!"); }
    }

    function rescueMouse() {
        if(cheese >= 100) { cheese -= 100; reputation += 20; updateUI(); saveGame(); } 
        else { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—ã—Ä–∞!"); }
    }

    function buyFlight() {
        if(cheese >= 100) {
            cheese -= 100;
            alert("‚úàÔ∏è –£–ª–µ—Ç–∞–µ–º –Ω–∞ –°—ã—Ä–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞! (–ö–æ–Ω–µ—Ü –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏)");
            updateUI(); saveGame();
        } else {
            alert("–£ —Ç–µ–±—è –Ω–µ—Ç 100 üßÄ –Ω–∞ –±–∏–ª–µ—Ç!");
        }
    }

    // --- –ú–ê–§–ò–Ø –ò –ü–ï–†–ï–•–û–î–´ ---
    function checkMafiaTrigger() {
        if (isMafia) return false;
        if (Math.random() < 0.15 && cheese > 50) { showMafiaWindow(); return true; }
        return false;
    }

    function showMafiaWindow() {
        document.getElementById('mafia-overlay').style.display = 'flex';
        const btns = document.getElementById('mafia-btns');
        document.getElementById('mafia-msg-text').innerText = "–û–Ω–∏ —Ö–æ—Ç—è—Ç —Ç–≤–æ–π —Å—ã—Ä!";
        btns.innerHTML = `<button class="btn" onclick="payMafia()">–û–¢–î–ê–¢–¨</button><button class="btn" onclick="startFight(false)">–ë–ò–¢–¨–°–Ø!</button>`;
    }

    function payMafia() {
        let loss = Math.floor(cheese * 0.3);
        cheese -= loss;
        hideMafia();
    }

    function startFight(isQuitting) {
        document.getElementById('fight-status').innerText = "–ë–û–ô...";
        setTimeout(() => {
            if(Math.random() > 0.5) {
                if(isQuitting) { isMafia = false; reputation = 0; }
                else { cheese += 50; }
                alert("–ü–æ–±–µ–¥–∞!");
            } else { cheese = 0; alert("–¢–µ–±—è –æ–±–æ–±—Ä–∞–ª–∏!"); }
            hideMafia();
        }, 1000);
    }

    function travelToBar() { if(!checkMafiaTrigger()) window.location.href = "/ratbar/"; }
    function travelToMetro() { if(!checkMafiaTrigger()) window.location.href = "/ratmetro/"; }
    function hideMafia() { document.getElementById('mafia-overlay').style.display = 'none'; updateUI(); saveGame(); }
    function quitMafiaRequest() { document.getElementById('mafia-overlay').style.display = 'flex'; startFight(true); }
    function robberyAttempt() { if(Math.random()>0.6){ cheese+=50; reputation-=5; } else { reputation-=10; } updateUI(); saveGame(); }

    // --- –†–´–ù–û–ö ---
    function startMarketGame() {
        if(checkMafiaTrigger()) return;
        openView('market-view');
        gameActive = true;
        let timeLeft = 15;
        let timer = setInterval(() => {
            timeLeft--;
            document.getElementById('market-timer').innerText = timeLeft;
            if(timeLeft <= 0 || !gameActive) { clearInterval(timer); gameActive = false; exitView('market-view'); }
        }, 1000);
        spawnCheese();
    }

    function spawnCheese() {
        if(!gameActive) return;
        const zone = document.getElementById('market-game-zone');
        const item = document.createElement('div');
        item.className = 'falling-cheese'; item.innerText = "üßÄ";
        item.style.left = Math.random() * 80 + "%"; item.style.top = "0px";
        zone.appendChild(item);
        let pos = 0;
        let fall = setInterval(() => {
            pos += 5; item.style.top = pos + "px";
            if(pos > 280) { clearInterval(fall); if(item.parentNode) zone.removeChild(item); }
        }, 40);
        item.onclick = () => { cheese += 2; updateUI(); if(item.parentNode) zone.removeChild(item); };
        setTimeout(spawnCheese, 700);
    }

    function openView(id) { document.querySelectorAll('.container').forEach(v => v.style.display = 'none'); document.getElementById(id).style.display = 'block'; }
    function exitView(id) { document.getElementById(id).style.display = 'none'; document.getElementById('main-view').style.display = 'block'; }
    function resetGame() { localStorage.clear(); location.reload(); }

    window.onload = loadGame;
</script>
</body>
</html>
